<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.com.gome.dujia.mapper.business.ZbyRecomInfoMapper" >
  <resultMap id="BaseResultMap" type="cn.com.gome.dujia.model.ZbyRecomInfo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="product_id" property="productId" jdbcType="VARCHAR" />
    <result column="title" property="title" jdbcType="VARCHAR" />
    <result column="image_url" property="imageUrl" jdbcType="VARCHAR" />
    <result column="image_url_local" property="imageUrlLocal" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="update_user" property="updateUser" jdbcType="VARCHAR" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
    <result column="is_delete" property="isDelete" jdbcType="BIT" />
    <result column="titleCount" property="titleCount" jdbcType="INTEGER" />
  </resultMap>
  
  <sql id="table_zby_recom_info">zby_recom_info</sql>
  
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    id, product_id, title, image_url, image_url_local, create_time, update_user, update_time, 
    is_delete
  </sql>
    
    <resultMap id="simpleResultMap" type="cn.com.gome.dujia.dto.QuickLinkDto" >
        <result column="id" property="id" jdbcType="VARCHAR" />
        <result column="name" property="name" jdbcType="VARCHAR" />
    </resultMap>
    
    <!--获取城市下线路最多的主题列表-->
    <select id="queryRecomByCity" resultMap="simpleResultMap" parameterType="java.lang.String">
        SELECT count(*) sort,r.id AS id, r.title AS NAME
        FROM zby_product p, zby_recom_info r
        WHERE r.product_id = p.product_id
        AND p.city_id = #{cityId}
        AND r.is_delete =0
        GROUP BY r.title
        ORDER BY sort DESC
        LIMIT 6
    </select>
    
    <select id="queryRecomInfoList" resultMap="BaseResultMap" parameterType="cn.com.gome.dujia.model.ZbyRecomInfo">
        SELECT  <include refid="Base_Column_List"/>,count(id) as titleCount
        FROM <include refid="table_zby_recom_info" />
        where 1=1
        <if test="startTime != null and startTime != '' ">
			<![CDATA[and create_time >= DATE_FORMAT(#{startTime,jdbcType=TIMESTAMP},'%Y-%m-%d %H-%i-%s')]]>
		</if>
		<if test="endTime != null and endTime != '' ">
			<![CDATA[and create_time <= DATE_FORMAT(#{endTime,jdbcType=TIMESTAMP},'%Y-%m-%d %H-%i-%s')]]>
		</if>
		<if test="title != null and title != '' ">
			and title like CONCAT('%',#{title,jdbcType=VARCHAR},'%')
		</if>
		<if test="isDelete != null">
			and is_delete = #{isDelete,jdbcType=BIT}
		</if>
		GROUP BY title
    </select>


    <select id="selectByProductId" resultMap="BaseResultMap" parameterType="java.lang.String">
        SELECT <include refid="Base_Column_List"/> from <include refid="table_zby_recom_info" />
        where product_id = #{productId}
    </select>


    
    <update id="updateRecomInfoStatus" parameterType="cn.com.gome.dujia.model.ZbyRecomInfo">
	    update <include refid="table_zby_recom_info" /> 
	    set is_delete = #{isDelete,jdbcType=BIT} , update_user = #{updateUser,jdbcType=VARCHAR} , update_time = #{updateTime,jdbcType=TIMESTAMP}
	    where title in 
	    <foreach collection="titleArray" index="index" item="item" open="(" close=")" separator=",">
    		#{item}
    	</foreach>
    </update>

    <insert id="batchInsert" parameterType="java.util.List">
        INSERT INTO zby_recom_info (
        id ,
        product_id ,
        title ,
        image_url ,
        image_url_local ,
        create_time ,
        update_time ,
        is_delete
        ) VALUES
        <foreach collection="list" index="index" item="item" separator=",">
            (
            #{item.id} ,
            #{item.productId} ,
            #{item.title} ,
            #{item.imageUrl} ,
            #{item.imageUrlLocal} ,
            #{item.createTime} ,
            #{item.updateTime} ,
            #{item.isDelete}
            )
        </foreach>
    </insert>

    <update id="updateIsDelete" parameterType="cn.com.gome.dujia.model.ZbyRecomInfo">
        UPDATE zby_recom_info SET
        is_delete = #{isDelete}
        WHERE
        id = #{id}
    </update>

    <!--<update id="selectNoProductId" parameterType="cn.com.gome.dujia.model.ZbyProduct">-->
        <!--UPDATE zby_recom_info SET-->
        <!--is_delete = #{isDelete}-->
        <!--WHERE-->
        <!--product_id = #{productId}-->
    <!--</update>-->


	<!-- 查询线路主题信息 -->
	<select id="queryRecomInfoByPIds" parameterType="java.util.List" resultMap="BaseResultMap">
		SELECT
		<include refid="Base_Column_List" />
		from zby_recom_info
		<where>
			<if test="list != null">
				and product_id in
				<foreach collection="list" item="item" index="index" open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
			and is_delete = false
		</where>
	</select>
	
	<!-- 查询更新的主题信息 -->
	<select id="queryUpdateRecomInfoList" resultMap="BaseResultMap" parameterType="cn.com.gome.dujia.model.ZbyRecomInfo">
        SELECT t1.* from zby_recom_info t1, 
        (select product_id from zby_recom_info where <![CDATA[ update_time >= #{updateTime,jdbcType=TIMESTAMP} ]]> group by product_id) t2
        where t1.product_id=t2.product_id
    </select>

</mapper>