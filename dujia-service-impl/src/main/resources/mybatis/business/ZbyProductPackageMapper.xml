<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.com.gome.dujia.mapper.business.ZbyProductPackageMapper" >
  <resultMap id="BaseResultMap" type="cn.com.gome.dujia.model.ZbyProductPackage" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="package_id" property="packageId" jdbcType="VARCHAR" />
    <result column="product_id" property="productId" jdbcType="VARCHAR" />
    <result column="package_name" property="packageName" jdbcType="VARCHAR" />
    <result column="package_long_name" property="packageLongName" jdbcType="VARCHAR" />
    <result column="package_short_name" property="packageShortName" jdbcType="VARCHAR" />
    <result column="package_description" property="packageDescription" jdbcType="VARCHAR" />
    <result column="all_count_num" property="allCountNum" jdbcType="INTEGER" />
    <result column="adult_num" property="adultNum" jdbcType="INTEGER" />
    <result column="child_num" property="childNum" jdbcType="INTEGER" />
    <result column="advance_day" property="advanceDay" jdbcType="INTEGER" />
    <result column="advance_time" property="advanceTime" jdbcType="VARCHAR" />
    <result column="sort" property="sort" jdbcType="INTEGER" />
    <result column="fee_include_info" property="feeIncludeInfo" jdbcType="LONGVARCHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
    <result column="is_delete" property="isDelete" jdbcType="BIT" />
    <result column="sale_count" property="saleCount" jdbcType="INTEGER" />
    <!-- 价格信息,非实体属性，用于前端展示-->
    <result column="package_sale_date" property="packageSaleDate_dis" jdbcType="DATE" />
    <result column="retail_price" property="retailPrice_dis" jdbcType="DECIMAL" />
    <result column="distribution_sale_price" property="distributionSalePrice_dis" jdbcType="DECIMAL" />
    <result column="tc_direct_price" property="tcDirectPrice_dis" jdbcType="DECIMAL" />
    <result column="inventory_remainder" property="inventoryRemainder" jdbcType="INTEGER"/>
    <result column="inventory_stats" property="inventoryStats" jdbcType="TINYINT"/>
    <result column="opening_sale" property="openingSale" jdbcType="BIT"/>
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    package_id, product_id, package_name, package_long_name, package_short_name, package_description, 
    all_count_num, adult_num, child_num, advance_day, advance_time, sort, fee_include_info, 
    create_time, update_time, is_delete,sale_count
  </sql>

 <select id="queryPackages" resultMap="BaseResultMap" parameterType="java.util.Map">
     SELECT
      b.tc_direct_price,
      b.retail_price,
      b.distribution_sale_price,
      b.package_sale_date,
      b.inventory_remainder,
      b.inventory_stats,
      b.opening_sale,
      a.*
    FROM
        zby_product_package a,
        zby_product_package_price b
    WHERE
        a.package_id = b.package_id
    AND a.product_id = #{productId}
    AND a.is_delete = 0
    -- AND b.inventory_stats!=4
    -- AND b.opening_sale=0
    AND DATE_FORMAT(b.package_sale_date,'%Y%m%d') = #{saleDate}
    AND DATE_FORMAT(DATE_SUB( #{saleDate}, INTERVAL a.advance_day DAY ),'%Y%m%d') >= DATE_FORMAT(NOW(),'%Y%m%d')
    GROUP BY b.package_id
    ORDER BY a.sort DESC
 </select>

  <insert id="batchInsert" parameterType="java.util.List">
    INSERT INTO zby_product_package (
    package_id ,
    product_id ,
    package_name ,
    package_long_name ,
    package_short_name ,
    package_description ,
    all_count_num ,
    adult_num ,
    child_num ,
    advance_day ,
    advance_time ,
    sort ,
    fee_include_info ,
    create_time ,
    update_time ,
    is_delete
    ) VALUES
    <foreach collection="list" index="index" item="item" separator=",">
      (
      #{item.packageId} ,
      #{item.productId} ,
      #{item.packageName} ,
      #{item.packageLongName} ,
      #{item.packageShortName} ,
      #{item.packageDescription} ,
      #{item.allCountNum} ,
      #{item.adultNum} ,
      #{item.childNum} ,
      #{item.advanceDay} ,
      #{item.advanceTime} ,
      #{item.sort} ,
      #{item.feeIncludeInfo} ,
      #{item.createTime} ,
      #{item.updateTime} ,
      #{item.isDelete}
      )
    </foreach>
  </insert>

    <update id="deleteByProductId" parameterType="java.lang.String">
        UPDATE zby_product_package SET
        is_delete = 1
        WHERE
        product_id = #{productId}
    </update>

    <update id="deleteByPackageId" parameterType="java.lang.String">
        UPDATE zby_product_package SET
        is_delete = 1
        WHERE
        package_id = #{packageId}
    </update>

    <!-- 根据主键查找套餐信息 -->
    <select id="selectByPackageId" resultMap="BaseResultMap" parameterType="java.lang.String">
        select
        <include refid="Base_Column_List" />
        from zby_product_package
        where package_id = #{packageId,jdbcType=VARCHAR}
    </select>

    <!-- 查询线路根据线路IDs-->
    <select id="selectInPackageIds"  parameterType="java.lang.String">
        SELECT * from zby_product_package where package_id in
        <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
            #{item.packageId}
        </foreach>
        and is_delete = #{isDelete}
    </select>

    <!-- 根据条件获取线路详情
    <select id="selectByPackageId" resultMap="BaseResultMap" parameterType="java.lang.String">
        SELECT *
        FROM zby_product_package
        WHERE package_id=#{packageId}
    </select>-->


    <update id="updateBySelective" >
          UPDATE zby_product_package
        <set>

            <if test="productId != null">
              product_id = #{productId},
            </if>

            <if test="packageName != null">
              package_name = #{packageName},
            </if>

            <if test="packageLongName != null">
              package_long_name = #{packageLongName},
            </if>
            <if test="packageShortName != null">
              package_short_name = #{packageShortName},
            </if>
            <if test="packageDescription != null">
              package_description = #{packageDescription},
            </if>
            <if test="allCountNum != null">
              all_count_num = #{allCountNum},
            </if>

            <if test="adultNum != null">
              adult_num = #{adultNum},
            </if>
            <if test="childNum != null">
              child_num = #{childNum},
            </if>
            <if test="advanceDay != null">
              advance_day = #{advanceDay},
            </if>
            <if test="advanceTime != null">
              advance_time = #{advanceTime},
            </if>

            <if test="advanceDay != null">
              advance_day = #{advanceDay},
            </if>

            <if test="sort != null">
              sort = #{sort},
            </if>

            <if test="feeIncludeInfo != null">
              fee_include_info = #{feeIncludeInfo},
            </if>

            <if test="updateTime != null">
              update_time = #{updateTime},
            </if>

            <if test="isDelete != null">
              is_delete = #{isDelete},
            </if>
        </set>
        WHERE
	        package_id = #{packageId}
    </update>

    <!-- 更新售卖量 -->
    <update id="updateSellCount" parameterType="cn.com.gome.dujia.model.ZbyProductPackage">
        update zby_product_package
        SET sale_count = sale_count + #{saleCount}
        WHERE product_id = #{productId}
          AND package_id = #{packageId}
    </update>

	<!-- 线路套餐列表 -->
	<select id="queryProductPackages" resultMap="BaseResultMap" parameterType="java.util.Map">
	SELECT
      min(b.tc_direct_price) tc_direct_price,
      a.package_id,
      a.product_id,
      a.package_name 
    FROM
        zby_product_package a,
        zby_product_package_price b
    WHERE
        a.package_id = b.package_id
    AND a.product_id = #{productId}
    AND a.is_delete = #{isDelete}
    GROUP BY b.package_id
    ORDER BY a.sort DESC
 </select>
</mapper>