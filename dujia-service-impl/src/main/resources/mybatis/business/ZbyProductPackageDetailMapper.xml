<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.com.gome.dujia.mapper.business.ZbyProductPackageDetailMapper">
    <resultMap id="BaseResultMap" type="cn.com.gome.dujia.model.ZbyProductPackageDetail">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="product_id" property="productId" jdbcType="VARCHAR"/>
        <result column="package_id" property="packageId" jdbcType="VARCHAR"/>
        <result column="related_id" property="relatedId" jdbcType="INTEGER"/>
        <result column="res_id" property="resId" jdbcType="INTEGER"/>
        <result column="tc_scenery_related_id" property="tcSceneryRelatedId" jdbcType="VARCHAR"/>
        <result column="res_name" property="resName" jdbcType="VARCHAR"/>
        <result column="res_type" property="resType" jdbcType="TINYINT"/>
        <result column="res_pro_id" property="resProId" jdbcType="INTEGER"/>
        <result column="res_pro_name" property="resProName" jdbcType="VARCHAR"/>
        <result column="sup_id" property="supId" jdbcType="INTEGER"/>
        <result column="sup_pp_id" property="supPpId" jdbcType="INTEGER"/>
        <result column="sup_pp_name" property="supPpName" jdbcType="VARCHAR"/>
        <result column="pro_price" property="proPrice" jdbcType="VARCHAR"/>
        <result column="pro_contain_type" property="proContainType" jdbcType="INTEGER"/>
        <result column="pro_contain_count" property="proContainCount" jdbcType="INTEGER"/>
        <result column="net" property="net" jdbcType="VARCHAR"/>
        <result column="booking_days" property="bookingDays" jdbcType="VARCHAR"/>
        <result column="need_card" property="needCard" jdbcType="VARCHAR"/>
        <result column="get_ticket_way" property="getTicketWay" jdbcType="VARCHAR"/>
        <result column="res_phone" property="resPhone" jdbcType="VARCHAR"/>
        <result column="pro_props" property="proProps" jdbcType="LONGVARCHAR"/>
        <result column="address" property="address" jdbcType="VARCHAR"/>
        <result column="res_city" property="resCity" jdbcType="VARCHAR"/>
        <result column="start_time" property="startTime" jdbcType="VARCHAR"/>
        <result column="res_grade" property="resGrade" jdbcType="VARCHAR"/>
        <result column="res_intro" property="resIntro" jdbcType="LONGVARCHAR"/>
        <result column="use_day" property="useDay" jdbcType="VARCHAR"/>
        <result column="res_image_list_local" property="resImageListLocal" jdbcType="LONGVARCHAR"/>
        <result column="res_image_list" property="resImageList" jdbcType="LONGVARCHAR"/>
        <result column="lon" property="lon" jdbcType="VARCHAR"/>
        <result column="lat" property="lat" jdbcType="VARCHAR"/>
    </resultMap>

    <sql id="Base_Column_List">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        id, product_id, package_id, related_id, res_id, tc_scenery_related_id, res_name,
        res_type, res_pro_id, res_pro_name, sup_id, sup_pp_id, sup_pp_name, pro_price, pro_contain_type,
        pro_contain_count, net, booking_days, need_card, get_ticket_way, res_phone, pro_props,
        address, res_city, start_time, res_grade, res_intro, use_day, res_image_list_local,
        res_image_list, lon, lat
    </sql>

    <resultMap id="productResourceDtoMap" type="cn.com.gome.dujia.dto.ZbyProductResourceDto">
        <result column="res_id" property="resId" jdbcType="INTEGER"/>
        <result column="related_id" property="relatedId" jdbcType="INTEGER"/>
        <result column="res_name" property="resName" jdbcType="VARCHAR"/>
        <result column="res_type" property="resType" jdbcType="TINYINT"/>
        <result column="res_pro_name" property="resProName" jdbcType="VARCHAR"/>
        <result column="lon" property="lon" jdbcType="VARCHAR"/>
        <result column="lat" property="lat" jdbcType="VARCHAR"/>
    </resultMap>

    <resultMap id="simpleResultMap" type="cn.com.gome.dujia.dto.QuickLinkDto">
        <result column="id" property="id" jdbcType="VARCHAR"/>
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <result column="cityId" property="cityId" jdbcType="VARCHAR"/>
        <result column="cityName" property="cityName" jdbcType="VARCHAR"/>
    </resultMap>

    <resultMap id="ResSimpleDtoMap" type="cn.com.gome.dujia.dto.ZbyPackageResourceSimpleDto">
        <result column="product_id" property="productId" jdbcType="VARCHAR"/>
        <result column="package_id" property="packageId" jdbcType="VARCHAR"/>
        <result column="res_id" property="resId" jdbcType="INTEGER"/>
        <result column="res_name" property="resName" jdbcType="VARCHAR"/>
        <result column="res_type" property="resType" jdbcType="TINYINT"/>
        <result column="res_pro_id" property="resProId" jdbcType="INTEGER"/>
        <result column="res_pro_name" property="resProName" jdbcType="VARCHAR"/>
        <result column="sup_pp_id" property="supPpId" jdbcType="INTEGER"/>
        <result column="sup_pp_name" property="supPpName" jdbcType="VARCHAR"/>
        <result column="pro_contain_type" property="proContainType" jdbcType="INTEGER"/>
        <result column="pro_contain_count" property="proContainCount" jdbcType="INTEGER"/>
        <result column="bed_type" property="bedType" jdbcType="VARCHAR"/>
    </resultMap>

    <resultMap id="SimpleBaseResultMap" type="cn.com.gome.dujia.model.ZbyProductPackageDetail">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="product_id" property="productId" jdbcType="VARCHAR"/>
        <result column="package_id" property="packageId" jdbcType="VARCHAR"/>
        <result column="res_id" property="resId" jdbcType="INTEGER"/>
        <result column="res_name" property="resName" jdbcType="VARCHAR"/>
        <result column="res_type" property="resType" jdbcType="TINYINT"/>
        <result column="res_pro_name" property="resProName" jdbcType="VARCHAR"/>
        <result column="res_phone" property="resPhone" jdbcType="VARCHAR"/>
        <result column="address" property="address" jdbcType="VARCHAR"/>
        <result column="res_city" property="resCity" jdbcType="VARCHAR"/>
        <result column="start_time" property="startTime" jdbcType="VARCHAR"/>
        <result column="res_grade" property="resGrade" jdbcType="VARCHAR"/>
        <result column="res_intro" property="resIntro" jdbcType="LONGVARCHAR"/>
        <result column="res_image_list_local" property="resImageListLocal" jdbcType="LONGVARCHAR"/>
        <result column="res_image_list" property="resImageList" jdbcType="LONGVARCHAR"/>
        <result column="pro_contain_type" property="proContainType" jdbcType="INTEGER"/>
        <result column="pro_contain_count" property="proContainCount" jdbcType="INTEGER"/>
        <result column="pro_props" property="proProps" jdbcType="LONGVARCHAR"/>
    </resultMap>

    <!-- 根据线路ID,获取线路的资源-->
    <select id="queryResourceByProductId" resultMap="productResourceDtoMap" parameterType="java.lang.String">
        SELECT
        <include refid="Base_Column_List"/>
        FROM zby_product_package_detail
        WHERE 1=1
        AND product_id = #{productId}
        GROUP BY res_id
    </select>
    
    <!-- 根据线路ID,获取线路的资源-->
    <select id="queryResourceByPackageId" resultMap="productResourceDtoMap" parameterType="java.lang.String">
        SELECT
        <include refid="Base_Column_List"/>
        FROM zby_product_package_detail
        WHERE 1=1
        AND package_id = #{packageId}
        GROUP BY res_id
    </select>

    <!-- 获取城市的热门景点列表-->
    <select id="queryCityHotSceneryBySize" resultMap="simpleResultMap" parameterType="java.util.Map">
       SELECT
            COUNT(*) sort,
            p.city_id AS cityId,
            p.city_name AS cityName,
            d.res_id AS id,
            d.res_name AS name
        FROM
            zby_product p,
            zby_product_package_detail d
        WHERE
            p.city_id = #{cityId}
        AND p.product_id = d.product_id
        AND d.res_type = '1'
        GROUP BY
            d.res_id
        ORDER BY
            sort DESC
        <if test="size != null ">
        LIMIT #{size}
        </if>
    </select>
    <!-- 根据线路id,套餐id，查询套餐的资源-->
    <select id="queryPackageRes" resultMap="SimpleBaseResultMap" parameterType="cn.com.gome.dujia.model.ZbyProductPackageDetail">
        SELECT
            id,
            product_id,
            package_id,
            res_id,
            res_name,
            res_type,
            res_pro_id,
            res_pro_name,
            sup_id,
            sup_pp_id,
            sup_pp_name,
            pro_price,
            pro_contain_type,
            pro_contain_count,
            net,
            booking_days,
            need_card,
            get_ticket_way,
            res_phone,
            pro_props,
            address,
            res_city,
            start_time,
            res_grade,
            pro_props
        FROM
        zby_product_package_detail
        WHERE
        product_id = #{productId}
        AND package_id = #{packageId}
    </select>

    <!-- 根据线路id,套餐id列表，批量查询套餐的资源-->
    <select id="queryPackageSimpleRes" resultMap="ResSimpleDtoMap" parameterType="java.util.Map">
       SELECT
            product_id,
            package_id,
            res_id,
            res_name,
            res_type,
            res_pro_id,
            res_pro_name,
            sup_pp_id,
            sup_pp_name,
            pro_contain_type,
            pro_contain_count,
            bed_type
        FROM
            zby_product_package_detail
        WHERE
            product_id = #{productId}
        AND package_id IN
        <foreach collection="packageIdList" item="packageId" index="index" open="("  separator="," close=")">
            #{packageId}
        </foreach>
        GROUP BY package_id,res_id
    </select>

    <insert id="batchInsert" parameterType="java.util.List">
        INSERT INTO zby_product_package_detail (
        id ,
        product_id ,
        package_id ,
        related_id ,
        res_id ,
        tc_scenery_related_id ,
        res_name ,
        res_type ,
        res_pro_id ,
        res_pro_name ,
        sup_id ,
        sup_pp_id ,
        sup_pp_name ,
        pro_price ,
        pro_contain_type ,
        pro_contain_count ,
        net ,
        booking_days ,
        need_card ,
        get_ticket_way ,
        res_phone ,
        pro_props ,
        address ,
        res_city ,
        start_time ,
        res_grade ,
        res_intro ,
        use_day ,
        res_image_list_local ,
        res_image_list ,
        lon ,
        lat,
        bed_type
        ) VALUES
        <foreach collection="list" index="index" item="item" separator=",">

            (
            #{item.id} ,
            #{item.productId} ,
            #{item.packageId} ,
            #{item.relatedId} ,
            #{item.resId} ,
            #{item.tcSceneryRelatedId} ,
            #{item.resName} ,
            #{item.resType} ,
            #{item.resProId} ,
            #{item.resProName} ,
            #{item.supId} ,
            #{item.supPpId} ,
            #{item.supPpName} ,
            #{item.proPrice} ,
            #{item.proContainType} ,
            #{item.proContainCount} ,
            #{item.net} ,
            #{item.bookingDays} ,
            #{item.needCard} ,
            #{item.getTicketWay} ,
            #{item.resPhone} ,
            #{item.proProps} ,
            #{item.address} ,
            #{item.resCity} ,
            #{item.startTime} ,
            #{item.resGrade} ,
            #{item.resIntro} ,
            #{item.useDay} ,
            #{item.resImageListLocal} ,
            #{item.resImageList} ,
            #{item.lon} ,
            #{item.lat},
            #{item.bedType}
            )
        </foreach>
    </insert>



    <insert id="insertReturnPri" parameterType="cn.com.gome.dujia.model.ZbyProductPackageDetail" useGeneratedKeys="true" keyProperty="id" >
        INSERT INTO zby_product_package_detail (
        id ,
        product_id ,
        package_id ,
        related_id ,
        res_id ,
        tc_scenery_related_id ,
        res_name ,
        res_type ,
        res_pro_id ,
        res_pro_name ,
        sup_id ,
        sup_pp_id ,
        sup_pp_name ,
        pro_price ,
        pro_contain_type ,
        pro_contain_count ,
        net ,
        booking_days ,
        need_card ,
        get_ticket_way ,
        res_phone ,
        pro_props ,
        address ,
        res_city ,
        start_time ,
        res_grade ,
        res_intro ,
        use_day ,
        res_image_list_local ,
        res_image_list ,
        lon ,
        lat,
        bed_type,
        update_time
        ) VALUES

            (
            #{id} ,
            #{productId} ,
            #{packageId} ,
            #{relatedId} ,
            #{resId} ,
            #{tcSceneryRelatedId} ,
            #{resName} ,
            #{resType} ,
            #{resProId} ,
            #{resProName} ,
            #{supId} ,
            #{supPpId} ,
            #{supPpName} ,
            #{proPrice} ,
            #{proContainType} ,
            #{proContainCount} ,
            #{net} ,
            #{bookingDays} ,
            #{needCard} ,
            #{getTicketWay} ,
            #{resPhone} ,
            #{proProps} ,
            #{address} ,
            #{resCity} ,
            #{startTime} ,
            #{resGrade} ,
            #{resIntro} ,
            #{useDay} ,
            #{resImageListLocal} ,
            #{resImageList} ,
            #{lon} ,
            #{lat},
            #{bedType},
            #{updateTime}
            )
    </insert>




	<!-- 获取线路资源信息 -->
	<select id="queryResInfoByPIds" parameterType="java.util.List" resultMap="BaseResultMap">
		select product_id, res_id, res_name, res_city, res_grade, res_type
		from zby_product_package_detail
		<where>
			<if test="list != null">
				and product_id in
				<foreach collection="list" item="item" index="index" open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
		</where>
		group by product_id, res_id
	</select>


    <!-- 根据 资源id 获取资源信息-->
    <select id="queryResInfoById" resultMap="SimpleBaseResultMap" parameterType="java.lang.String">
        SELECT
           *
        FROM
            zby_product_package_detail
        WHERE
            res_id = #{resId}
        GROUP BY
            res_id
    </select>

    <delete id="deleteByPackageId" parameterType="java.lang.String">
        delete from zby_product_package_detail where package_id = #{packageId}
    </delete>

	<select id="queryPackageDetailByPackageId" resultMap="BaseResultMap" parameterType="java.util.Map">
        select <include refid="Base_Column_List" />
        from zby_product_package_detail
        <where>
        	package_id=#{packageId}
        </where>
    </select>
    <!-- 查询城市下销量、浏览量最多的前10个景区-->
    <select id="querySceneryBySaleOrBrowseCount" resultMap="productResourceDtoMap" parameterType="java.lang.String">
        SELECT
            *
        FROM
            (
                SELECT
                    k.product_id,
                    k.package_id,
                    k.sale_count,
                    k.browse_count,
                    d.res_id,
                    d.res_name
                FROM
                    (
                        SELECT
                            p.product_id,
                            p.package_id,
                            p.sale_count,
                            t.browse_count
                        FROM
                            zby_product t,
                            zby_product_package p
                        WHERE
                            p.product_id = t.product_id
                        AND p.is_delete = 0
                        AND t.is_delete = 0
                        <if test="_parameter != null and _parameter!=''">
                        AND t.city_id = #{cityId}
                        </if>
                        ORDER BY
                            p.sale_count DESC,
                            t.browse_count DESC
                    ) k
                LEFT JOIN zby_product_package_detail d ON d.package_id = k.package_id
                WHERE
                    d.res_type = 1
                GROUP BY
                    d.res_id
                LIMIT 10
            ) rs
        ORDER BY
            rs.sale_count DESC,
            rs.browse_count DESC
    </select>

    <!-- 根据订单编号，产品编号，套餐编号查询信息 -->
<select id="getPackageDetailList" resultMap="BaseResultMap" parameterType="java.util.Map">
SELECT zppd.* FROM zby_product_package_detail zppd
JOIN dj_order o ON o.product_id=zppd.product_id AND o.package_id=zppd.package_id
JOIN dj_order_detail od ON o.order_id=od.order_id AND zppd.related_id=od.resource_id
WHERE o.product_id=#{productId} AND o.package_id=#{packageId} AND o.order_id=#{orderId}
ORDER BY od.resource_type,od.use_start_time
</select>



<!-- 查询接口不存在的套餐详情 -->
<select id="selectByProductIdAndRedId"  resultMap="BaseResultMap">
    select id,product_id
    from zby_product_package_detail
    where product_id = #{productId} and
    CONCAT(package_id,res_id) NOT IN
    <foreach collection="list" item="item" index="index" open="(" separator="," close=")">
        #{item}
    </foreach>
</select>


</mapper>