<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.com.gome.dujia.mapper.business.OrderMapper">
    <resultMap id="BaseResultMap" type="cn.com.gome.dujia.model.Order">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="user_id" property="userId" jdbcType="VARCHAR"/>
        <result column="user_name" property="userName" jdbcType="VARCHAR"/>
        <result column="order_id" property="orderId" jdbcType="VARCHAR"/>
        <result column="order_status" property="orderStatus" jdbcType="TINYINT"/>
        <result column="order_pay" property="orderPay" jdbcType="TINYINT"/>
        <result column="order_source" property="orderSource" jdbcType="TINYINT"/>
        <result column="order_total_amount" property="orderTotalAmount" jdbcType="DECIMAL"/>
        <result column="order_amount" property="orderAmount" jdbcType="DECIMAL"/>
        <result column="package_price" property="packagePrice" jdbcType="DECIMAL"/>
        <result column="insurance_amount" property="insuranceAmount" jdbcType="DECIMAL"/>
        <result column="compensate_amount" property="compensateAmount" jdbcType="DECIMAL"/>
        <result column="penalty_amount" property="penaltyAmount" jdbcType="DECIMAL"/>
        <result column="payment_amount" property="paymentAmount" jdbcType="DECIMAL"/>
        <result column="product_id" property="productId" jdbcType="VARCHAR"/>
        <result column="product_name" property="productName" jdbcType="VARCHAR"/>
        <result column="package_id" property="packageId" jdbcType="VARCHAR"/>
        <result column="package_name" property="packageName" jdbcType="VARCHAR"/>
        <result column="buy_count" property="buyCount" jdbcType="INTEGER"/>
        <result column="vender_id" property="venderId" jdbcType="VARCHAR"/>
        <result column="vender_order_id" property="venderOrderId" jdbcType="VARCHAR"/>
        <result column="vender_order_status" property="venderOrderStatus" jdbcType="TINYINT"/>
        <result column="vender_pay_status" property="venderPayStatus" jdbcType="TINYINT"/>
        <result column="lnvoice_type" property="lnvoiceType" jdbcType="TINYINT"/>
        <result column="lnvoice_title" property="lnvoiceTitle" jdbcType="VARCHAR"/>
        <result column="lnvoice_content" property="lnvoiceContent" jdbcType="VARCHAR"/>
        <result column="business_type" property="businessType" jdbcType="TINYINT"/>
        <result column="order_active" property="orderActive" jdbcType="TINYINT"/>
        <result column="promotion_id" property="promotionId" jdbcType="INTEGER"/>
        <result column="promotion_amount" property="promotionAmount" jdbcType="DECIMAL"/>
        <result column="coupons_id" property="couponsId" jdbcType="INTEGER"/>
        <result column="coupons_amount" property="couponsAmount" jdbcType="DECIMAL"/>
        <result column="balance" property="balance" jdbcType="DECIMAL"/>
        <result column="contacts_name" property="contactsName" jdbcType="VARCHAR"/>
        <result column="contacts_telphone" property="contactsTelphone" jdbcType="VARCHAR"/>
        <result column="contacts_email" property="contactsEmail" jdbcType="VARCHAR"/>
        <result column="travel_day" property="travelDay" jdbcType="INTEGER"/>
        <result column="travel_start_time" property="travelStartTime" jdbcType="TIMESTAMP"/>
        <result column="travel_end_time" property="travelEndTime" jdbcType="TIMESTAMP"/>
        <result column="travel_people" property="travelPeople" jdbcType="VARCHAR"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
        <result column="order_time" property="orderTime" jdbcType="TIMESTAMP"/>
        <result column="extended1" jdbcType="VARCHAR" property="extended1"/>
        <result column="extended2" jdbcType="VARCHAR" property="extended2"/>
        <result column="adult_num" jdbcType="INTEGER" property="adultNum"/>
        <result column="child_num" jdbcType="INTEGER" property="childNum"/>

    </resultMap>
    <sql id="Base_Column_List">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        id, user_id, user_name, order_id, order_status, order_pay, order_source, order_total_amount,
        order_amount, package_price, insurance_amount, compensate_amount, penalty_amount, payment_amount,
        product_id, package_id, package_name, buy_count, vender_id, vender_order_id, adult_num, child_num,
        vender_order_status, vender_pay_status, lnvoice_type, lnvoice_title,
        lnvoice_content, business_type, order_active, promotion_id, promotion_amount, coupons_id,
        coupons_amount, balance, product_name, contacts_name, contacts_telphone, contacts_email,
        travel_day, travel_start_time, travel_end_time,travel_people ,extended1, extended2, create_time,
        update_time,order_time
    </sql>


    <!-- 动态获取订单列表 -->
    <select id="queryOrderList" resultMap="BaseResultMap" parameterType="cn.com.gome.dujia.model.Order">
        select
        <include refid="Base_Column_List"/>
        from dj_order
        <where>
            <if test="orderId !=null">
                and order_id = #{orderId,jdbcType=VARCHAR}
            </if>

            <if test="venderOrderId !=null">
                and vender_order_id = #{venderOrderId,jdbcType=VARCHAR}
            </if>

            <if test="orderStatus != null">
                and order_status = #{orderStatus,jdbcType=INTEGER }
            </if>

            <if test="orderPay != null">
                and order_pay = #{orderPay,jdbcType=TINYINT}
            </if>
        </where>
    </select>

    <!-- 根据订单ID，查询订单信息 -->
    <select id="queryOrderInfo" resultMap="BaseResultMap" parameterType="java.lang.String">
        select
        <include refid="Base_Column_List"/>
        from dj_order
        where order_id = #{orderId,jdbcType=VARCHAR}
    </select>

    <!-- 根据OrderVO动态获取订单列表 -->
    <select id="queryOrderListByVO" resultType="cn.com.gome.dujia.vo.order.OrderQueryInfo"
            parameterType="cn.com.gome.dujia.vo.order.OrderQueryInfo">
        SELECT
        o.id,
        o.user_name AS userName,
        o.vender_order_id AS venderOrderId,
        o.user_id AS userId,
        o.contacts_telphone AS contactsTelphone,
        o.order_id AS orderId,
        o.order_amount AS orderAmount,
        o.order_source AS orderSource,
        o.order_status AS orderStatus,
        o.buy_count AS buyCount,
        o.create_time AS createTime,
        o.order_pay AS payStatus,
        o.travel_day AS travelDay,
        o.travel_start_time AS travelStartTime,
        o.order_time AS orderTime,
        o.product_id AS productId,
        o.package_id AS packageId,
        p.sub_name AS productName,
        p.begin_date AS productStartTime,
        p.over_date AS productEndTime,
        p.city_id AS packageCityId,
        p.city_name AS packageCityName,
        k.merchant_no AS merchantNo,
        k.trans_no AS transNo,
        k.pay_time AS payTime,
        sps.sap_type AS sapType
        FROM
        dj_order o
        LEFT JOIN zby_product p ON o.product_id = p.product_id
        LEFT JOIN zby_product_package pp ON o.product_id=pp.product_id AND o.package_id=pp.package_id
        LEFT JOIN
        (SELECT group_concat(p.trans_no) AS trans_no,p.merchant_no,p.order_id,p.pay_time FROM dj_order_pay p GROUP BY
        p.order_id
        )k ON k.order_id = o.order_id
        LEFT JOIN
        (
        SELECT s.id,MAX(s.sap_type) AS sap_type,s.order_id FROM dj_push_sap s WHERE s.push_status='3' AND s.order_id NOT
        IN(
        SELECT s1.order_id FROM dj_push_sap s1 WHERE s1.sap_type=3 OR s1.sap_type=4 GROUP BY s1.order_id
        ) GROUP BY s.order_id
        ) sps ON sps.order_id = o.order_id
        LEFT JOIN
        (
        SELECT (SELECT GROUP_CONCAT(title) title FROM zby_recom_info zri WHERE is_delete=0 AND
        zri.product_id=djo.product_id) recomTitle,product_id,order_id FROM dj_order djo
        ) oo ON o.order_id=oo.order_id
        LEFT JOIN
        (
        SELECT (SELECT GROUP_CONCAT(res_name) packageName FROM zby_product_package_detail ppd WHERE ppd.res_type=1 AND
        ppd.product_id=djo.product_id AND ppd.package_id=djo.package_id) packageName,order_id FROM dj_order djo
        ) op ON o.order_id=op.order_id
        WHERE 1 = 1
        <if test="orderId !=null and orderId !='' ">
            and o.order_id like CONCAT('%', #{orderId,jdbcType=VARCHAR},'%')
        </if>
        <if test="contactsTelphone !=null and contactsTelphone !='' ">
            and o.contacts_telphone like CONCAT('%', #{contactsTelphone,jdbcType=VARCHAR},'%')
        </if>
        <if test="userName !=null and userName!=''">
            and o.user_name like CONCAT('%',#{userName,jdbcType=VARCHAR},'%')
        </if>
        <if test="productName !=null and productName!=''">
            and p.sub_name like CONCAT('%',#{productName,jdbcType=VARCHAR},'%')
        </if>
        <if test="orderStatus != null">
            and o.order_status = #{orderStatus,jdbcType=INTEGER }
        </if>
        <if test="payStatus != null">
            and o.order_pay = #{payStatus,jdbcType=TINYINT}
        </if>
        <if test="packageCityID !=null ">
            and p.city_id = #{packageCityID ,jdbcType=INTEGER}
        </if>
        <if test="packageCityName !=null and packageCityName !=''">
            and p.city_name like CONCAT('%',#{packageCityName,jdbcType=VARCHAR},'%')
        </if>
        <if test="orderSource !=null">
            and o.order_source = #{orderSource,jdbcType=TINYINT}
        </if>
        <if test="orderStartTime != null">
            <![CDATA[and o.order_time >= DATE_FORMAT(#{orderStartTime,jdbcType=TIMESTAMP},'%Y-%m-%d %H-%i-%s')]]>
        </if>
        <if test="orderEndTime != null">
            <![CDATA[and o.order_time < DATE_FORMAT(DATE_ADD(#{orderEndTime,jdbcType=TIMESTAMP},INTERVAL 1 DAY),'%Y-%m-%d %H-%i-%s')]]>
        </if>
        <if test="payStartTime != null">
            <![CDATA[and k.pay_time >= DATE_FORMAT(#{payStartTime,jdbcType=TIMESTAMP},'%Y-%m-%d %H-%i-%s')]]>
        </if>
        <if test="payEndTime != null">
            <![CDATA[and k.pay_time < DATE_FORMAT(DATE_ADD(#{payEndTime,jdbcType=TIMESTAMP},INTERVAL 1 DAY),'%Y-%m-%d %H-%i-%s')]]>
        </if>
        <if test="transNo !=null and transNo !=''">
            and k.trans_no like CONCAT('%',#{transNo,jdbcType=VARCHAR},'%')
        </if>
        <if test="travelDay !=null">
            and o.travel_day =#{travelDay,jdbcType=INTEGER}
        </if>
        <if test="recomTitle !=null and recomTitle !=''">
            AND o.order_id in(
            SELECT DISTINCT order_id FROM zby_recom_info zri
            JOIN dj_order dj ON dj.product_id=zri.product_id
            WHERE is_delete=0 AND title LIKE CONCAT('%',#{recomTitle,jdbcType=VARCHAR},'%')
            )
        </if>
        <if test="packageName !=null and packageName!=''">
            AND o.order_id in(
            SELECT distinct dj.order_id FROM zby_product_package_detail ppd
            JOIN dj_order dj ON dj.product_id = ppd.product_id AND dj.package_id=ppd.package_id
            WHERE res_type=1 AND ppd.res_name LIKE CONCAT('%',#{packageName,jdbcType=VARCHAR},'%')
            )
        </if>
        <if test="sapType!=null ">
            and sps.sap_type = #{sapType,jdbcType=TINYINT}
        </if>
        <if test="productId !=null and productId !=''">
            and o.product_id = #{productId,jdbcType=VARCHAR}
        </if>
        ORDER BY o.order_id DESC
    </select>


    <!-- 根据条件查询订单信息-->
    <select id="getOrderByIds" parameterType="java.util.Map" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from dj_order
        <where>
            <if test="userId != null">
                and user_id = #{userId,jdbcType=VARCHAR}
            </if>
            <if test="orderId != null">
                and order_id = #{orderId,jdbcType=VARCHAR}
            </if>
        </where>
    </select>

    <!-- 批量更新 -->
    <update id="batchUpdate" parameterType="java.util.List">
        <foreach collection="list" index="index" item="item" separator=";">
            update dj_order
            <set>
                <if test="item.orderStatus != null">
                    order_status = #{item.orderStatus,jdbcType=TINYINT},
                </if>

                <if test="item.orderPay != null">
                    order_pay = #{item.orderPay,jdbcType=TINYINT},
                </if>

                <if test="item.updateTime != null">
                    update_time = #{item.updateTime,jdbcType=TIMESTAMP},
                </if>
            </set>
            where order_id = #{item.orderId,jdbcType=VARCHAR}
        </foreach>
    </update>

    <!-- 根据用户ID、时间，获取订单列表 -->
    <select id="queryUserOrderInfos" parameterType="cn.com.gome.dujia.dto.QueryUserOrderReq" resultMap="BaseResultMap">
        select
        order_id,
        create_time,
        travel_start_time,
        package_name,
        package_price,
        buy_count,
        order_amount,
        order_status
        from
        dj_order
        where
        user_id = #{userId,jdbcType=VARCHAR}

        <if test="dateBeforeNow != null">
            <![CDATA[ and create_time >=  #{dateBeforeNow,jdbcType=TIMESTAMP} ]]>
        </if>

        <if test="dateAfterNow != null">
            <![CDATA[ and create_time <=  #{dateAfterNow,jdbcType=TIMESTAMP} ]]>
        </if>

        <if test="orderNo != null">
            <![CDATA[ and  order_id like CONCAT('%',#{orderNo,jdbcType=VARCHAR},'%' ) ]]>
        </if>

        <if test="orderStatus !=null">
            and order_status = #{orderStatus,jdbcType=TINYINT}
        </if>
        ORDER BY
        create_time
        DESC
    </select>

    <!-- 统计用户指定状态下的订单数量 -->
    <select id="countOrderByStatus" resultType="java.lang.Integer" parameterType="cn.com.gome.dujia.model.Order">
        select count(*) from dj_order
        where 1=1
        <if test="userId != null">
            and user_id = #{userId,jdbcType=VARCHAR}
        </if>
        <if test="orderStatus != null">
            and order_status = #{orderStatus,jdbcType=TINYINT}
        </if>
    </select>

    <!-- 根据条件查询订单信息-->
    <select id="getOrderByVenderOrderIds" parameterType="java.lang.String" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from dj_order
        where order_id IN (#{venderOrderIds})
    </select>

    <!-- 根据条件查询订单信息， 加锁-->
    <select id="getOrderInfoForUpdate" parameterType="cn.com.gome.dujia.model.Order" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from dj_order
        <where>
            <if test="userId != null">
                and user_id = #{userId,jdbcType=VARCHAR}
            </if>
            <if test="orderId != null">
                and order_id = #{orderId,jdbcType=VARCHAR}
            </if>
        </where>
        for update
    </select>

    <update id="updateOrderInfo" parameterType="cn.com.gome.dujia.model.Order">
        update dj_order
        <set>
            <if test="orderStatus != null">
                order_status = #{orderStatus},
            </if>

            <if test="orderSource != null">
                order_source = #{orderSource},
            </if>

            <if test="orderPay != null">
                order_pay = #{orderPay},
            </if>

            <if test="venderOrderId != null">
                vender_order_id = #{venderOrderId},
            </if>

            <if test="updateTime != null">
                update_time = #{updateTime}
            </if>
        </set>
        where order_id = #{orderId}
    </update>


    <select id="queryOrderListByParam" parameterType="cn.com.gome.dujia.vo.order.OrderQueryParam"
            resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from dj_order
        <where>
            <if test="orderStatus != null">
                and order_status = #{orderStatus,jdbcType=TINYINT}
            </if>

            <if test="nonOrderStatus != null">
                and order_status != #{nonOrderStatus,jdbcType=TINYINT}
            </if>

            <if test="payStatus != null">
                and order_pay = #{payStatus,jdbcType=TINYINT}
            </if>

            <if test="venderOrderId != null">
                and vender_order_id IS NOT NULL
            </if>

            <if test="judgeEndTime != null">
                and NOW() >= DATE_ADD(travel_end_time,INTERVAL 1 DAY)
            </if>

            <if test="orderSapParam != null">
                AND order_id NOT IN (SELECT djps.order_id FROM dj_push_sap djps WHERE djps.sap_type = 2)
            </if>

            <if test="refundSapParam != null">
                AND order_id NOT IN (SELECT djps.order_id FROM dj_push_sap djps WHERE djps.sap_type = 4)
            </if>
        </where>
    </select>

</mapper>