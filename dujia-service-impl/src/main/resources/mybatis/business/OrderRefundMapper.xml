<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.com.gome.dujia.mapper.business.OrderRefundMapper">
    <resultMap id="BaseResultMap" type="cn.com.gome.dujia.model.OrderRefund">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="user_id" property="userId" jdbcType="VARCHAR"/>
        <result column="user_name" property="userName" jdbcType="VARCHAR"/>
        <result column="order_id" property="orderId" jdbcType="VARCHAR"/>
        <result column="vender_order_id" property="venderOrderId" jdbcType="VARCHAR"/>
        <result column="refund_id" property="refundId" jdbcType="VARCHAR"/>
        <result column="vender_refund_id" property="venderRefundId" jdbcType="VARCHAR"/>
        <result column="pay_amount" property="payAmount" jdbcType="DECIMAL"/>
        <result column="refund_amount" property="refundAmount" jdbcType="DECIMAL"/>
        <result column="compensate_amount" property="compensateAmount" jdbcType="DECIMAL"/>
        <result column="penalty_amount" property="penaltyAmount" jdbcType="DECIMAL"/>
        <result column="deduct_mount" property="deductMount" jdbcType="DECIMAL"/>
        <result column="return_amount" property="returnAmount" jdbcType="DECIMAL"/>
        <result column="pay_mode" property="payMode" jdbcType="VARCHAR"/>
        <result column="pay_mode_sap" property="payModeSap" jdbcType="VARCHAR"/>
        <result column="pay_time" property="payTime" jdbcType="TIMESTAMP"/>
        <result column="trans_no" property="transNo" jdbcType="VARCHAR"/>
        <result column="audit_name" property="auditName" jdbcType="VARCHAR"/>
        <result column="audit_time" property="auditTime" jdbcType="TIMESTAMP"/>
        <result column="audit_note" property="auditNote" jdbcType="VARCHAR"/>
        <result column="refund_form" property="refundForm" jdbcType="TINYINT"/>
        <result column="refund_reason" property="refundReason" jdbcType="TINYINT"/>
        <result column="refund_type" property="refundType" jdbcType="TINYINT"/>
        <result column="refund_mode" property="refundMode" jdbcType="TINYINT"/>
        <result column="refund_status" property="refundStatus" jdbcType="TINYINT"/>
        <result column="refund_source" property="refundSource" jdbcType="TINYINT"/>
        <result column="refund_bank_trans_num" property="refundBankTransNum" jdbcType="VARCHAR"/>
        <result column="finish_time" property="finishTime" jdbcType="TIMESTAMP"/>
        <result column="refund_note" property="refundNote" jdbcType="VARCHAR"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
    </resultMap>
    <sql id="Base_Column_List">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        id, user_id, user_name, order_id, vender_order_id, refund_id, vender_refund_id, pay_amount, refund_amount,
        compensate_amount, penalty_amount, deduct_mount, return_amount, pay_mode, pay_mode_sap,
        pay_time, trans_no, audit_name, audit_time, audit_note, refund_form, refund_reason,
        refund_type, refund_mode, refund_status, refund_source, refund_bank_trans_num, finish_time,
        refund_note, create_time, update_time
    </sql>


    <select id="queryOrderRefundList" parameterType="cn.com.gome.dujia.model.OrderRefund" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from dj_order_refund
        <where>
            <if test="userId != null">
                and user_id = #{userId,jdbcType=VARCHAR}
            </if>
            <if test="orderId != null">
                and order_id = #{orderId,jdbcType=VARCHAR}
            </if>
            <if test="refundId != null">
                and refund_id = #{refundId,jdbcType=VARCHAR}
            </if>
            <if test="venderRefundId != null">
                and vender_refund_id = #{venderRefundId,jdbcType=VARCHAR}
            </if>
            <if test="refundStatus != null">
                and refund_status = #{refundStatus,jdbcType=TINYINT}
            </if>
            <if test="refundReason != null">
                and refund_reason = #{refundReason,jdbcType=TINYINT}
            </if>
        </where>
    </select>

    <!-- 根据推送sap信息查询退款单信息 -->
    <select id="queryOrderRefundByPushSap" resultMap="BaseResultMap" parameterType="java.util.Map">
        select t1.*
        from dj_order_refund t1, dj_push_sap t2
        <where>
            t1.refund_id = t2.business_no
            <if test="sapType != null">
                and t2.sap_type = #{sapType,jdbcType=TINYINT}
            </if>
            <if test="sapStatusList !=null">
                and t2.push_status in
                <foreach close=")" collection="sapStatusList" index="index" item="item" open="(" separator=",">
                    #{item}
                </foreach>
            </if>
            <if test="pushNum != null">
                <![CDATA[and t2.push_num < #{pushNum,jdbcType=INTEGER}]]>
            </if>
        </where>
    </select>

    <select id="queryOrderRefundInfoList" resultType="cn.com.gome.dujia.vo.refund.OrderRefundInfo"
            parameterType="cn.com.gome.dujia.vo.refund.OrderRefundInfo">
        SELECT
        dor.id,
        dor.refund_id AS refundId,
        dor.order_id AS orderId,
        dor.user_name AS userName,
        dor.user_id AS userId,
        dor.create_time AS createTime,
        dor.return_amount AS returnAmount,
        dor.refund_reason AS refundReason,
        dor.refund_status AS refundStatus,
        dor.refund_type AS refundType,
        dor.refund_mode AS refundMode,
        dor.finish_time AS finishTime,
        dor.audit_time AS auditTime,
        dor.audit_name AS auditName,
        dor.vender_order_id AS venderOrderId,
        dop.trans_no AS payTrxorderId,
        dop.pay_time AS orderPayTime,
        dop.pay_money AS orderPayMoney,
        dop.pay_mode AS orderPayMode,
        dop.pay_mode_sap AS orderPayModeSap
        FROM
        dj_order_refund dor
        LEFT JOIN
        dj_order doi ON dor.order_id = doi.order_id
        LEFT JOIN
        dj_order_pay dop ON doi.order_id = dop.order_id AND dor.trans_no = dop.merchant_no

        WHERE 1 = 1

        <!-- 退款单号 -->
        <if test="refundId != null and refundId != '' ">
            and dor.refund_id like CONCAT('%', #{refundId,jdbcType=VARCHAR},'%')
        </if>

        <!-- 订单编号 -->
        <if test="orderId != null and orderId != '' ">
            and dor.order_id like CONCAT('%', #{orderId,jdbcType=VARCHAR},'%')
        </if>

        <!-- 用户帐号 -->
        <if test="userName != null and userName != '' ">
            and dor.user_name like CONCAT('%', #{userName,jdbcType=VARCHAR},'%')
        </if>

        <!-- 用户ID -->
        <if test="userId != null and userId != '' ">
            and dor.user_id like CONCAT('%', #{userId,jdbcType=VARCHAR},'%')
        </if>

        <!-- 退款原因 -->
        <if test="refundReason != null">
            and dor.refund_reason = #{refundReason,jdbcType=TINYINT}
        </if>

        <!-- 退款类型 -->
        <if test="refundType != null">
            and dor.refund_type = #{refundType,jdbcType=TINYINT}
        </if>

        <!-- 退款状态 -->
        <if test="refundStatus != null">
            and dor.refund_status = #{refundStatus,jdbcType=TINYINT}
        </if>

        <!-- 退款创建时间 -->
        <if test="startTime != null">
            <![CDATA[and dor.create_time >= DATE_FORMAT(#{startTime,jdbcType=DATE},'%Y-%m-%d %H-%i-%s')]]>
        </if>

        <if test="endTime != null">
            <![CDATA[and dor.create_time < DATE_FORMAT(DATE_ADD(#{endTime,jdbcType=DATE},INTERVAL 1 DAY),'%Y-%m-%d %H-%i-%s')]]>
        </if>

        <!-- 退款审核时间 -->
        <if test="auditeStartTime != null">
            <![CDATA[and dor.audit_time >= DATE_FORMAT(#{auditeStartTime,jdbcType=DATE},'%Y-%m-%d %H-%i-%s')]]>
        </if>

        <if test="auditeEndTime != null">
            <![CDATA[and dor.audit_time < DATE_FORMAT(DATE_ADD(#{auditeEndTime,jdbcType=DATE},INTERVAL 1 DAY),'%Y-%m-%d %H-%i-%s')]]>
        </if>

        <!-- 退款完成时间 -->
        <if test="refundFinishStartTime != null">
            <![CDATA[and dor.finish_time >= DATE_FORMAT(#{refundFinishStartTime,jdbcType=DATE},'%Y-%m-%d %H-%i-%s')]]>
        </if>

        <if test="refundFinishEndTime != null">
            <![CDATA[and dor.finish_time < DATE_FORMAT(DATE_ADD(#{refundFinishEndTime,jdbcType=DATE},INTERVAL 1 DAY),'%Y-%m-%d %H-%i-%s')]]>
        </if>

        <!-- 支付订单号 -->
        <if test="payTrxorderId != null and payTrxorderId != '' ">
            and dop.trans_no like CONCAT('%', #{payTrxorderId,jdbcType=VARCHAR},'%')
        </if>

        <!-- 供应商订单号-->
        <if test="venderOrderId != null and venderOrderId !='' ">
            and dor.vender_order_id like CONCAT('%', #{venderOrderId,jdbcType=VARCHAR},'%')
        </if>

        <!-- 退款支付平台-->
        <if test="orderPayModeSap != null and orderPayModeSap != ''">
            and dop.pay_mode_sap = #{orderPayModeSap,jdbcType=VARCHAR}
        </if>

        <!-- 审核方式 系统审核 -->
        <if test="auditStatus != null">
            and dor.refund_reason = 0
        </if>

        <!-- 审核方式 人工审核 -->
        <if test="nonAuditStatus != null">
            and dor.refund_reason != 0
        </if>

        <!-- 排除几种退款状态 -->
        <if test="nonRefundStatus != null">
            and dor.refund_status != #{nonRefundStatus,jdbcType=TINYINT}
        </if>

        <!-- 包含几种退款状态 -->
        <if test="refundStatusList != null and refundStatusList.size() >0 ">
            and dor.refund_status in
            <foreach collection="refundStatusList" index="index" item="refundStatusList" open="(" separator=","
                     close=")">
                #{refundStatusList}
            </foreach>
        </if>

        ORDER BY dor.refund_id DESC
    </select>


    <select id="queryOrderRefund" parameterType="java.lang.String" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from
        dj_order_refund
        <where>
            <if test="_parameter != null and _parameter!=''">
                and refund_id = #{_parameter}
            </if>
        </where>
    </select>

    <update id="updateOrderRefund" parameterType="cn.com.gome.dujia.model.OrderRefund">
        UPDATE dj_order_refund
        <set>
            <if test="refundStatus != null">
                refund_status = #{refundStatus},
            </if>

            <if test="updateTime != null">
                update_time = #{updateTime},
            </if>

            <if test="finishTime != null">
                finish_time = #{finishTime},
            </if>

            <if test="refundBankTransNum != null">
                refund_bank_trans_num = #{refundBankTransNum},
            </if>

            <if test="auditNote != null">
                audit_note = #{auditNote},
            </if>

            <if test="auditTime != null">
                audit_time = #{auditTime},
            </if>

            <if test="auditName != null">
                audit_name = #{auditName},
            </if>

        </set>
        where refund_id = #{refundId}
    </update>


    <select id="queryRefundList" parameterType="cn.com.gome.dujia.vo.refund.OrderRefundInfo" resultMap="BaseResultMap">
        select
            <include refid="Base_Column_List"/>
        from
        dj_order_refund
        <where>
            <if test="orderIdList != null">
                and order_id IN
                <foreach collection="orderIdList" item="item" index="index" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>

            <if test="refundStatus != null">
                and refund_status = #{refundStatus,jdbcType=TINYINT}
            </if>

        </where>
    </select>
</mapper>